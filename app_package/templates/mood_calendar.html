<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mood Calendar - {{ month_name }} {{ year }}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* Add basic styling to display emojis in a row and space the count */
        .day-content-container { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: space-between; 
            height: 100%; /* important for positioning the count */
        }
        .day-emoji-container {
            display: flex;
            flex-wrap: wrap; /* Allows emojis to wrap to the next line */
            justify-content: center;
            margin-top: 5px;
        }
        .day-emoji {
            font-size: 1.5em; /* Make the emojis visible */
            margin: 0 2px;
            cursor: help; /* Indicate that these are clickable/hoverable */
        }
        .total-input-message {
            font-size: 0.7em;
            color: #777;
            margin-top: auto; /* Pushes the count to the bottom of the cell */
            text-align: center;
        }
        .modal-entry {
            border-left: 5px solid;
            padding-left: 10px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="layout">
        <div class="sidebar">
            <nav>
                </nav>
        </div>

        <div class="main-section">

            <header class="topbar">
                <h1>Mood calendar</h1>
            </header>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <a href="#">&larr; Prev Month</a> 
                <h1>{{ month_name }} {{ year }}</h1>
                <a href="#">Next Month &rarr;</a>
            </div>
            <h2>Mood Calendar for {{ month_name }} {{ year }}</h2>
            <p>Styling and interactive features (like clicking) are disabled to remove syntax errors.</p>
            <table class="mood-calendar-table">
                <thead class="calendar-header">
                    <tr>
                        <th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th><th>Sun</th>
                    </tr>
                </thead>
                <tbody class="calendar-body">
                    {% for week in calendar %}
                    <tr class="week-row">
                        {% for day in week %}
                            {% if day != 0 %}
                                {# The 'day' variable is an integer, convert to string for lookup #}
                                {% set day_str = day|string %}
                                {% set day_data = mood_data.get(day_str) %}
                                
                                <td class="{{ 'logged-day' if day_data else '' }}" 
                                    {% if day_data %}
                                        {# PASS ONLY THE DAY NUMBER. JS will fetch all entries #}
                                        onclick="showDayDetails('{{ day_str }}')"
                                    {% endif %}>
                                    <div class="day-number">{{ day }}</div>
                                    
                                    {# --- START OF NEW LOGIC --- #}
                                    {% if day_data %}
                                        <div class="day-content-container">
                                            {# Display all emojis in a container #}
                                            <div class="day-emoji-container">
                                                {% for entry in day_data.entries %}
                                                    <span class="day-emoji" 
                                                          style="color: '{{ entry.color }}';" 
                                                          title="{{ entry.emotion }} ({{ entry.timestamp }})">
                                                        {{ entry.emoji }}
                                                    </span>
                                                {% endfor %}
                                            </div>
                                            
                                            {# Display the total count message #}
                                            <div class="total-input-message">
                                                Total Input: {{ day_data.total_entries }}
                                            </div>
                                        </div>
                                    {% endif %}
                                    {# --- END OF NEW LOGIC --- #}
                                </td>
                            {% else %}
                                <td class="empty-day"></td>
                            {% endif %}
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <div class="mood-sum">
                <h2>ðŸ“Š Mood Summary</h2>
                <p><strong>Total Mood Entries Logged (Month):</strong> {{ mood_summary.total_entries }}</p>
                <p><strong>Most Frequent Mood:</strong> {{ mood_summary.most_frequent }}</p>
            </div>

            <hr>
            
            <h3>Emotion Breakdown:</h3>
            <ul class="breakdown-list">
                {% for emotion, count in mood_summary.emotion_breakdown.items() %}
                    <li><strong>{{ emotion }}</strong>: {{ count }} entries</li>
                {% endfor %}
            </ul>
            
            
            <div id="mood-modal" class="mood-modal">
                <div id="modal-content" class="modal-content">
                    <span onclick="document.getElementById('mood-modal').style.display='none'" class="close">&times;</span>
                    <h2>Details for Day <span id="modal-day"></span></h2>
                    
                    {# Container to be filled dynamically by JavaScript #}
                    <div id="modal-entries-container">
                        </div>
                    
                </div>
            </div>

        </div>
    </div>
    
    <script>
        // Store the mood data passed from Flask in a JavaScript variable
        const MOOD_DATA = '{{ mood_data | tojson }}';
    </script>
    
    {# Move the script block to the end of the body for best performance #}
    <script>
        function formatTimestamp(isoTimestamp) {
            let date = new Date(isoTimestamp);
            return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) + ' on ' + date.toLocaleDateString();
        }

        function showDayDetails(day) {
            
            const dayData = MOOD_DATA[day];
            if (!dayData || dayData.entries.length === 0) {
                return;
            }

            // 1. Prepare Modal Header
            document.getElementById('modal-day').textContent = day;
            
            // 2. Clear and Populate Entry Container
            const container = document.getElementById('modal-entries-container');
            container.innerHTML = '';
            
            dayData.entries.forEach((entry, index) => {
                // Create a div for each individual entry
                const entryDiv = document.createElement('div');
                entryDiv.className = 'modal-entry';
                // Use the entry's color for the left border (using the style from the <head>)
                entryDiv.style.borderColor = entry.color; 
                
                // Populate the entry details
                entryDiv.innerHTML = `
                    <p><strong>Entry #${index + 1}</strong></p>
                    <p><strong>Time:</strong> ${formatTimestamp(entry.timestamp)}</p>
                    <p><strong>Emotion:</strong> ${entry.emotion} <span style="font-size: 1.5em">${entry.emoji}</span></p>
                    <p><strong>Note:</strong> ${entry.note || 'No note provided.'}</p>
                `;
                container.appendChild(entryDiv);
            });

            // 3. Style and Display
            // Note: Since we have multiple entries, styling the border with one color is tricky.
            // We use the last entry's color for the main modal border, or keep it neutral.
            let modalContent = document.getElementById('modal-content');
            modalContent.style.borderColor = dayData.entries[dayData.entries.length - 1].color; 
            document.getElementById('mood-modal').style.display = 'block';
        }

        // Close modal when clicking outside of it (kept the original logic)
        window.onclick = function(event) {
            let modal = document.getElementById('mood-modal');
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    </script>
    
</body>
</html>