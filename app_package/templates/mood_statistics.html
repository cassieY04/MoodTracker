<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        const currentTheme = "{{ session.get('theme', 'light') }}";
        document.documentElement.setAttribute('data-theme', currentTheme);
    </script>
    <script src="{{ url_for('static', filename='theme.js') }}"></script>
    <meta charset="UTF-8">
    <title>Mood Statistics</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="layout">
        <div class="sidebar">
            <div class="logo2">
                <i class="fas fa-heart-pulse"></i>
            </div>
            <nav>
            <ul class="menu">
                <li><a href="/dashboard"><i class="fa fa-dashboard"></i><span>Dashboard</span></a></li>
                <li><a href="/log_emotion"><i class="fas fa-pencil-alt"></i><span>Log Emotion</span></a></li>
                <li><a href="/mood_calendar"><i class="far fa-calendar-alt"></i><span>Mood Calendar</span></a></li>
                <li class="active"><a href="/mood_statistics"><i class="fas fa-chart-bar"></i><span>Mood Statistics</span></a></li>
                <li><a href="/ai_feedback"><i class="fas fa-star"></i><span>AI Feedback</span></a></li>
                <li><a href="/emotionhistory"><i class="fas fa-history"></i><span>Emotion History</span></a></li>
                <li><a href="/logout"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a></li>
                <li><a href="javascript:void(0)" id="theme-toggle" class="theme-btn-sidebar"><i id="theme-icon" class="fas fa-moon"></i><span>Theme</span></a></li>
            </ul>
            </nav>
        </div>

        <div class="main-section">
            <header class="topbar">
                <div class="header-title">
                    <span>MoodTracker</span>
                    <h1>Mood Statistics</h1>
                </div>
            </header>

            <div class="stats-page">
                <div class="stats-header-card">
                    <div class="stats-header-text">
                        <h2>Here are your mood statistic, {{ session.username }}!</h2>
                        <p>Let's break down your emotional trends.</p>
                    </div>
                    <div class="stats-header-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                </div>

                <div class="stats-tabs">
                    <a href="?period=daily" class="stats-tab-btn {% if period == 'daily' %}active{% endif %}">Daily</a>
                    <a href="?period=weekly" class="stats-tab-btn {% if period == 'weekly' %}active{% endif %}">Weekly</a>
                    <a href="?period=monthly" class="stats-tab-btn {% if period == 'monthly' %}active{% endif %}">Monthly</a>
                </div>

                {% if period == 'daily' %}
                <div class="stats-picker-container">
                    <label for="stats-date" class="picker-label">Select Date:</label>
                    <input type="date" id="stats-date" value="{{ selected_date }}" onchange="window.location.href='?period=daily&date='+this.value" class="picker-input">
                </div>
                {% endif %}

                {% if period == 'weekly' %}
                <div class="stats-picker-container">
                    <label for="stats-week" class="picker-label">Select Week:</label>
                    <input type="week" id="stats-week" value="{{ selected_week }}" onchange="window.location.href='?period=weekly&week='+this.value" class="picker-input">
                </div>
                {% endif %}

                {% if period == 'monthly' %}
                <div class="stats-picker-container">
                    <label for="stats-month" class="picker-label">Select Month:</label>
                    <input type="month" id="stats-month" value="{{ selected_month }}" onchange="window.location.href='?period=monthly&month='+this.value" class="picker-input">
                </div>
                {% endif %}

                <div class="stats-header-cards">
                    <div class="stat-card">
                        <div class="stat-icon-box total">
                            <i class="fas fa-layer-group"></i>
                        </div>
                        <div class="stat-details">
                            <h3>Logs ({{ period_title }})</h3>
                            <p>{{ total_logs|default(0) }}</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon-box mood">
                            <i class="fas fa-smile"></i>
                        </div>
                        <div class="stat-details">
                            <h3>Top Mood</h3>
                            <p>{{ top_mood|default('-') }}</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon-box streak">
                            <i class="fas fa-fire"></i>
                        </div>
                        <div class="stat-details">
                            <h3>Current Streak</h3>
                            <p>{{ streak|default(0) }} Days</p>
                        </div>
                    </div>
                </div>

                <!-- Charts Area -->
                <div class="charts-grid">
                    <div class="chart-container">
                        <h2>Mood Trends ({{ period_title }})</h2>
                        <canvas id="moodLineChart"></canvas>
                        <div class="ai-btn-container">
                            {% if period == 'daily' %}
                                <a href="/ai_feedback?date={{ selected_date }}" class="main-btn-ai-btn-large">Get AI Feedback</a>
                            {% elif period == 'weekly' %}
                                <a href="/ai_feedback?week={{ selected_week }}" class="main-btn-ai-btn-large">Get AI Feedback</a>
                            {% elif period == 'monthly' %}
                                <a href="/ai_feedback?month={{ selected_month }}" class="main-btn-ai-btn-large">Get AI Feedback</a>
                            {% else %}
                                <a href="/ai_feedback" class="main-btn-ai-btn-large">Get AI Feedback</a>
                            {% endif %}
                        </div>
                    </div>
                    <div class="chart-container">
                        <h2>Mood Distribution</h2>
                        <canvas id="moodPieChart"></canvas>
                        
                        <!-- Simple Colored Bars Breakdown -->
                        <div class="stats-breakdown-container">
                            {% for item in breakdown %}
                            <div class="breakdown-item">
                                <div class="breakdown-header">
                                    <span><img src="{{ url_for('static', filename='emotions/' + item.icon) }}" alt="{{ item.name }}" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 5px;"> {{ item.name }}</span>
                                    <span>{{ item.count }} ({{ item.percent }}%)</span>
                                </div>
                                <div class="progress-bar-bg">
                                    <div class="progress-bar-fill" style="width: {{ item.percent }}%; background-color: {{ item.color }};"></div>
                                </div>
                            </div>
                            {% endfor %}
                            {% if not breakdown %}
                            <p class="stats-no-data">No data for this period.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 1. Setup Data from Flask (using | tojson filter)
        const pieLabels = {{ pie_labels | tojson }};
        const pieData = {{ pie_data | tojson }};
        const pieColors = {{ pie_colors | tojson }};
        const lineLabels = {{ line_labels | tojson }};
        const lineData = {{ line_data | tojson }};

        // Helper to get CSS variable values
        function getCssVar(name) {
            return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
        }

        // Initial Theme Colors
        let textColor = getCssVar('--text-sub');
        let gridColor = getCssVar('--border-subtle');

        // 2. Mood Distribution Chart (Pie)
        const ctxPie = document.getElementById('moodPieChart').getContext('2d');
        const moodPieChart = new Chart(ctxPie, {
            type: 'doughnut',
            data: {
                labels: pieLabels,
                datasets: [{
                    data: pieData,
                    backgroundColor: pieColors,
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { 
                        position: 'bottom',
                        labels: { color: textColor }
                    }
                }
            }
        });

        // 3. Mood Trends Chart (Line)
        const ctxLine = document.getElementById('moodLineChart').getContext('2d');
        const moodLineChart = new Chart(ctxLine, {
            type: 'line',
            data: {
                labels: lineLabels,
                datasets: [{
                    label: 'Average Mood Score',
                    data: lineData,
                    borderColor: '#6f4bd8',
                    backgroundColor: 'rgba(111, 75, 216, 0.1)',
                    tension: 0.4, 
                    fill: true,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#6f4bd8',
                    pointRadius: 5
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        ticks: { color: textColor },
                        grid: { color: gridColor },
                        title: {
                            display: true,
                            text: '{% if period == "daily" %}Time{% elif period == "monthly" %}Date{% else %}Day{% endif %}',
                            color: textColor
                        }
                    },
                    y: {
                        beginAtZero: true,
                        max: 3.5,
                        ticks: { 
                            color: textColor,
                            callback: function(value) {
                                if(value === 1) return 'Negative';
                                if(value === 2) return 'Neutral';
                                if(value === 3) return 'Positive';
                                return '';
                            }
                        },
                        grid: { color: gridColor },
                        title: {
                            display: true,
                            text: 'Mood Level',
                            color: textColor
                        }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: (c) => `Score: ${c.raw}` } }
                }
            }
        });

        // 4. Listen for Theme Changes to update Chart Colors
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'attributes' && mutation.attributeName === 'data-theme') {
                    const newTextColor = getCssVar('--text-sub');
                    const newGridColor = getCssVar('--border-subtle');

                    // Update Line Chart
                    moodLineChart.options.scales.x.ticks.color = newTextColor;
                    moodLineChart.options.scales.x.grid.color = newGridColor;
                    moodLineChart.options.scales.x.title.color = newTextColor;

                    moodLineChart.options.scales.y.ticks.color = newTextColor;
                    moodLineChart.options.scales.y.grid.color = newGridColor;
                    moodLineChart.options.scales.y.title.color = newTextColor;
                    moodLineChart.update();

                    // Update Pie Chart 
                    moodPieChart.options.plugins.legend.labels.color = newTextColor;
                    moodPieChart.update();
                }
            });
        });

        observer.observe(document.documentElement, { attributes: true });
    </script>
</body>
</html>