{% macro render_feedback_card(data) %}
    <!-- Emotion Card -->
    <section class="ai-card">
        <h3>üé≠ Mood Level</h3>
        <div class="feedback-emoji-large">
            <img src="{{ url_for('static', filename='emotions/' + data.icon) }}" alt="{{ data.emotion }}" style="width: 45px; height: 45px; vertical-align: middle; margin-right: 10px;">
            <span style="vertical-align: middle;">{{ data.emotion|capitalize }}</span>
        </div>
        {% if data.timestamp %}
        <div class="feedback-timestamp">
            <i class="far fa-clock"></i> {{ data.timestamp }}
        </div>
        {% endif %}
    </section>

    <!-- User reflection -->
    <section class="ai-card reflection">
        <h3>‚úçÔ∏è Reflection & Timeline</h3>

        <div class="reflection-grid">
            <div class="reflection-box">
                <span class="ref-label">Situation</span>
                <p>{{ data.reflection.reason if data.reflection.reason else '-' }}</p>
            </div>
            <div class="reflection-box">
                <span class="ref-label">Thoughts</span>
                <p>{{ data.reflection.thought if data.reflection.thought else '-' }}</p>
            </div>
        </div>
    </section>

    <!-- AI analysis -->
    <section class="ai-card highlight">
        <h3>ü§ñ AI Analysis</h3>
        {% if data.causes %}
        <p class="feedback-intro-text">Here is what might be influencing your mood:</p>
        <ul>
            {% for c in data.causes[:5] %}
            <li>{{c}}</li>
            {% endfor %}
        </ul>
        {% else %}
        <p>No specific patterns detected, but your feelings are valid.</p>
        {% endif %}
    </section>

    <!-- AI suggestions -->
    <section class="ai-card suggestions">
        <h3>üå± Suggested Actions</h3>
        <p class="feedback-intro-text">Try these small steps to help you feel better:</p>
        <ul>
            {% for s in data.suggestions[:5] %}
            <li>{{s}}</li>
            {% endfor %}
        </ul>
    </section>

    <!-- Encouragement -->
    <section class="ai-card encouragement">
        <h3>üí° Word of Encouragement</h3>
        <p>"{{ data.encouragement }}"</p>
    </section>
{% endmacro %}

<!DOCTYPE html>
<html lang="en">
<head>
        <script>
        const currentTheme = "{{ session.get('theme', 'light') }}";
        document.documentElement.setAttribute('data-theme', currentTheme);
    </script>
    <script src="{{ url_for('static', filename='theme.js') }}"></script>
    <meta charset="UTF-8">
    <title>AI Feedback</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <div class="layout">

        <div class="sidebar">
            <div class="logo2"><i class="fas fa-heart-pulse"></i></div>
            
            <nav>
            <ul class="menu">
                <li><a href="/dashboard" ><i class="fa fa-dashboard"></i><span>Dashboard</span></a></li>
                <li><a href="/log_emotion"><i class="fas fa-pencil-alt"></i><span>Log Emotion</span></a></li>
                <li><a href="/mood_calendar"><i class="far fa-calendar-alt"></i><span>Mood Calendar</span></a></li>
                <li><a href="/mood_statistics"><i class="fas fa-chart-bar"></i><span>Mood Statistics</span></a></li>
                <li class="active"><a href="/ai_feedback"><i class="fas fa-star"></i><span>AI Feedback</span></a></li>
                <li><a href="/emotionhistory"><i class="fas fa-history"></i><span>Emotion History</span></a></li>
                <li><a href="/logout"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a></li>
                <li><a href="javascript:void(0)" id="theme-toggle" class="theme-btn-sidebar"><i id="theme-icon" class="fas fa-moon"></i><span>Theme</span></a></li>
            </ul>
            </nav>
            
        </div>

        <div class="main-section">

            <header class="topbar">
                <div class="header-title">
                    <span>MoodTracker</span>
                    <h1>AI Feedback</h1>
                </div>
            </header>

            <div class="ai-feedback-page">

                {% if empty%}
                <p> No emotion data available yet. </p>
                {% else %}
                
                <div class="ai-header-card">
                    <div class="ai-header-text">
                        <h2>Here's your feedback, {{ session.username }}!</h2>
                        <p>Let's break down what you're feeling.</p>
                    </div>
                    <div class="ai-header-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                </div>

                {% if view_type == 'single' %}
                    <!-- SINGLE LOG VIEW -->
                    {{ render_feedback_card(single_data) }}
                
                {% else %}
                    <!-- Normal View -->
                    <div class="tab-nav">
                        <button class="tab-btn {{ 'active' if active_tab == 'daily' else '' }}" onclick="openTab(event, 'daily')">Daily</button>
                        <button class="tab-btn {{ 'active' if active_tab == 'weekly' else '' }}" onclick="openTab(event, 'weekly')">Weekly</button>
                        <button class="tab-btn {{ 'active' if active_tab == 'monthly' else '' }}" onclick="openTab(event, 'monthly')">Monthly</button>
                    </div>

                    <div id="daily" class="tab-content {{ 'active' if active_tab == 'daily' else '' }}">
                        <div class="ai-picker-container">
                            <label for="ai-date" class="picker-label">View Date:</label>
                            <input type="date" id="ai-date" value="{{ selected_date }}" onchange="window.location.href='?date='+this.value" class="picker-input">
                        </div>

                        {% if daily_data %}
                            {{ render_feedback_card(daily_data) }}
                        {% else %}
                            <p class="no-logs-text">No feedback found for this date.</p>
                        {% endif %}
                    </div>

                    <div id="weekly" class="tab-content {{ 'active' if active_tab == 'weekly' else '' }}">
                        <div class="ai-picker-container">
                            <label for="ai-week" class="picker-label">View Week:</label>
                            <input type="week" id="ai-week" value="{{ selected_week }}" onchange="window.location.href='?week='+this.value" class="picker-input">
                        </div>

                        {% if weekly_data %}
                            {{ render_feedback_card(weekly_data) }}
                        {% else %}
                            <p class="no-logs-text">No feedback found for this week yet.</p>
                        {% endif %}
                    </div>

                    <div id="monthly" class="tab-content {{ 'active' if active_tab == 'monthly' else '' }}">
                        <div class="ai-picker-container">
                            <label for="ai-month" class="picker-label">View Month:</label>
                            <input type="month" id="ai-month" value="{{ selected_month }}" onchange="window.location.href='?month='+this.value" class="picker-input">
                        </div>

                        {% if monthly_data %}
                            {{ render_feedback_card(monthly_data) }}
                        {% else %}
                            <p class="no-logs-text">No feedback found for this month yet.</p>
                        {% endif %}
                    </div>
                {% endif %}

                {% endif %}

                {% if view_type == 'single' and not request.args.get('from_new') %}
                <div class="ai-footer">
                    <a href="{{ url_for('emotion_history.emotion_history') }}#log-{{ log_id }}">‚Üê Back to Emotion History</a>
                </div>
                {% endif %}

            </div>
        </div>
    </div>

    <script>
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tab-btn");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }
    </script>
</body>
</html>
